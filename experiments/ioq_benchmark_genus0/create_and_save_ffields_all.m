% Create and save ffields from the meshes in data_folder usng IOQ and MIQ.
% Uses all possible combinations of cpu/blockgpu/gpu inv and cpu/gpu loop for each mesh.

% See Mesh.saveFField for a description of the .ffield format.
%
% You can load an .ffield file by using:
%   m = Mesh();
%   m.loadFField('bunny.ffield');
%   m.draw();

%% Setup
global LOG;
global EPS;
global VERBOSE;
global PLOT;
global SAVE;
global DEGREE;
global ASPECT_RATIO;
global RESOLUTION;
VERBOSE = true;
EPS = 1e-9;
PLOT = true;
SAVE = true;
DEGREE = 4;
ASPECT_RATIO = 1;
RESOLUTION = 1024;    
LOG = -1;

F0 = [1];
THETA0 = [0];
% Constraint vector in global coordinates
G_CONSTRAINT_VEC = [1, 0, 0];
N_ITER = 1000;
%LB = 8000; % with 4gb gpu
LB = 20000; % with 12gb gpu

%experiment_name = 'bunnies_connectivity_lap';
%data_folder = '../data/bunnies';
%lap_graph = true;

%experiment_name = 'bunnies_cot_lap';
%data_folder = '../data/bunnies';
%lap_graph = false;

%experiment_name = 'genus0_connectivity_lap';
%data_folder = '../data/genus0';
%lap_graph = true;

experiment_name = 'genus0';
data_folder = '../data/genus0';

print_header(['experiment_name : ', experiment_name])

base_folder = fullfile('..', 'results', 'experiments', experiment_name);
out_folder_ffields = fullfile(base_folder, 'ffields');
out_folder_nrosy = fullfile(base_folder, 'nrosy');
out_folder_plots = fullfile(base_folder, 'plots');
ext = '.off';
ffield_ext = '.ffield';
nrosy_ext = '.rosy';

disp(['Results are being saved into ', base_folder])

opt_vanilla_graph = struct('inv_gpu', false, ...
    'iter_gpu', false, ...
    'TCODS', true, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', true);
opt_inv_cpu_graph = struct('inv_gpu', false, ...
    'CUDAKernel_reduce_cols', true, ...
    'TCODS', true, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', true);
opt_block_inv_gpu_graph = struct('block_inv_gpu', true, ...
    'CUDAKernel_reduce_cols', true, ...
    'TCODS', true, ...
    'lb', LB, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', true);
opt_inv_gpu_graph = struct('inv_gpu', true, ...
    'CUDAKernel_reduce_cols', true, ...
    'TCODS', true, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', true);

opt_vanilla_cot = struct('inv_gpu', false, ...
    'iter_gpu', false, ...
    'TCODS', true, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', false);
opt_inv_cpu_cot = struct('inv_gpu', false, ...
    'CUDAKernel_reduce_cols', true, ...
    'TCODS', true, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', false);
opt_block_inv_gpu_cot = struct('block_inv_gpu', true, ...
    'CUDAKernel_reduce_cols', true, ...
    'TCODS', true, ...
    'lb', LB, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', false);
opt_inv_gpu_cot = struct('inv_gpu', true, ...
    'CUDAKernel_reduce_cols', true, ...
    'TCODS', true, ...
    'gConstraintVec', G_CONSTRAINT_VEC, ...
    'graph', false);

experiments = {
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_vanilla_graph}}, ...
        'description', 'IOQ (cpu inv, cpu loop) with graph lap', ...
        'name', 'IOQ_graph_cpuinv_cpuloop', ...
        'save_ffield', true, ...
        'rerun', true, ...
        'legend', 'IOQ (cpuinv, cpuloop)', ...
        'symbol', '*'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_inv_cpu_graph}}, ...
        'description', 'IOQ (cpu inv, gpu loop) with graph lap', ...
        'name', 'IOQ_graph_cpuinv_gpuloop', ...
        'save_ffield', false, ...
        'rerun', true, ...
        'legend', 'IOQ (cpuinv, gpuloop)', ...
        'symbol', 'X'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_block_inv_gpu_graph}}, ...
        'description', 'IOQ (block inv, gpu loop) with graph lap', ...
        'name', 'IOQ_graph_blockinv_gpuloop', ...
        'save_ffield', true, ...
        'rerun', true, ...
        'legend', 'IOQ (blockinv, gpuloop)', ...
        'symbol', 'O'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_inv_gpu_graph}}, ...
        'description', 'IOQ (gpu inv, gpu loop) with graph lap', ...
        'name', 'IOQ_graph_gpuinv_gpuloop', ...
        'save_ffield', false, ...
        'rerun', true, ...
        'legend', 'IOQ (gpuinv, gpuloop)', ...
        'symbol', 's'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_vanilla_cot}}, ...
        'description', 'IOQ (cpu inv, cpu loop) with cot lap', ...
        'name', 'IOQ_cot_cpuinv_cpuloop', ...
        'save_ffield', true, ...
        'rerun', true, ...
        'legend', 'IOQ (cpuinv, cpuloop)', ...
        'symbol', '*'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_inv_cpu_cot}}, ...
        'description', 'IOQ (cpu inv, gpu loop) with cot lap', ...
        'name', 'IOQ_cot_cpuinv_gpuloop', ...
        'save_ffield', false, ...
        'rerun', true, ...
        'legend', 'IOQ (cpuinv, gpuloop)', ...
        'symbol', 'X'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_block_inv_gpu_cot}}, ...
        'description', 'IOQ (block inv, gpu loop) with cot lap', ...
        'name', 'IOQ_cot_blockinv_gpuloop', ...
        'save_ffield', true, ...
        'rerun', true, ...
        'legend', 'IOQ (blockinv, gpuloop)', ...
        'symbol', 'O'), ...
    struct(...
        'func', @run_lattice_iter, ...
        'args', {{F0, THETA0, DEGREE, N_ITER, opt_inv_gpu_cot}}, ...
        'description', 'IOQ (gpu inv, gpu loop) with cot lap', ...
        'name', 'IOQ_cot_gpuinv_gpuloop', ...
        'save_ffield', false, ...
        'rerun', true, ...
        'legend', 'IOQ (gpuinv, gpuloop)', ...
        'symbol', 's'), ...
    struct(...
        'func', @nrosy_mex, ...
        'args', {{F0, G_CONSTRAINT_VEC, DEGREE}}, ...
        'description', 'MIQ', ...
        'name', 'MIQ', ...
        'save_ffield', true, ...
        'rerun', true, ...
        'legend', 'MIQ', ...
        'symbol', '^'), ...
    };

% Create folders
if ~exist(out_folder_ffields, 'dir')
    mkdir(out_folder_ffields);
end
if ~exist(out_folder_nrosy, 'dir')
    mkdir(out_folder_nrosy);
end
if ~exist(out_folder_plots, 'dir')
    mkdir(out_folder_plots);
end

LOG = fopen(fullfile(out_folder_ffields, 'log.txt'), 'w');

%% Create and save ffields
filepaths = get_filepaths(data_folder, ext);
n_files = numel(filepaths);
n_experiments = numel(experiments);

stats_fp = fullfile(...
    '..', 'results', 'experiments', experiment_name, 'stats.mat');
%if exist(stats_fp, 'file')
%    stats = load(stats_fp);
%    stats = stats.stats;
%else
%    stats = cell(n_files, n_experiments);
%end

stats = cell(n_files+1, n_experiments+1);

rand_seed = rng;

for r = 1:n_files
    fp = filepaths{r};
    log_and_print(LOG, 'Mesh: %s\r\n', fp);
    
    [~, name, ~] = fileparts(fp);
    stats{r+1, 1} = name;
    
    energies = [];
    
    for c = 1:n_experiments
        exp = experiments{c};
        stats{1, c+1} = exp.name;
        
        if isfield(exp, 'rerun') && ~exp.rerun
            log_and_print(LOG, '\tSkipping experiment: %s\r\n', exp.description)
            continue;
        end
        
        log_and_print(LOG, '\tExperiment: %s\r\n', exp.description);
        log_and_print(LOG, '\t%g%%...\r\n', ((r-1)*n_experiments+c-1) / n_files*n_experiments);
        
        try
            rng(rand_seed);
            res = feval(exp.func, fp, exp.args{:});
            m = Mesh();
            m.loadTM(fp);
            m.set_ffield(...
                res.degree, ...
                res.local_frames, ...
                res.frame_diffs, ...
                res.theta, ...
                res.ffield, ...
                res.S, ...
                res.E)
            if isfield(exp, 'save_ffield') && exp.save_ffield
                [~, fname, ~] = fileparts(fp);
                out_fp_ffield = fullfile(out_folder_ffields, ...
                    [fname, '_', exp.name, ffield_ext]);
                log_and_print(LOG, 'Saving %s...\r\n', out_fp_ffield);
                m.saveFField(out_fp_ffield);
            end
            out_fp_nrosy = fullfile(out_folder_nrosy, ...
                    [fname, '_', exp.name, nrosy_ext]);
            m.saveNRosy(out_fp_nrosy, true);
            
            st.nV = m.nV;
            st.nF = m.nF;
            st.nE = m.nE;
            st.miq_energy = m.miq_energy;
            st.n_singularities = m.n_singularities;
            st.elapsed_total = res.elapsed_total;
            st.exp = exp; 
            st.failed = false;
            stats{r+1, c+1} = st;
            
            energies(end+1) = m.miq_energy;
        catch ME
            log_and_print(LOG, '\tExperiment failed. \r\n');
            log_and_print(LOG, '\tStack: %s\r\n', getReport(ME, 'extended'));
            stats{r+1, c+1}.failed = true;
            stats{r+1, c+1}.exp = exp;
        end
    
    end
    
    disp(['Energies (', name, ')'])
    disp(energies)
    
end

save(stats_fp, 'stats');

%% Save statistics
log_and_print(LOG, 'Saving statistics to %s...\r\n', stats_fp);
save(stats_fp, 'stats');
log_and_print(LOG, 'Done.\r\n');

% %% Plots
% plots = {...
%     struct(...
%         'title', 'Energy', ...
%         'name', 'energy', ...
%         'get_x_field', @(x) x.nF, ...
%         'get_y_field', @(x) x.miq_energy, ...
%         'style', {{'x'}}), ...
%     struct(...
%         'title', 'Elapsed time (total)', ...
%         'name', 'elapsed_total', ...
%         'get_x_field', @(x) x.nF, ...
%         'get_y_field', @(x) x.elapsed_total, ...
%         'style', {{'x'}}), ...
%     struct(...
%         'title', 'Number of Singularities', ...
%         'name', 'n_singularities', ...
%         'get_x_field', @(x) x.nF, ...
%         'get_y_field', @(x) x.n_singularities, ...
%         'style', {{'x'}})
%     };
% 
% e = cellfun(@(x) x.exp, stats(1,:));
% legends = {e.description};
% plot_results(plots, stats, legends, out_folder_plots)
% 
% 
%% Plot IOQ (graph) vs IOQ (cot) vs MIQ
% base_folder = fullfile('..', 'results', 'experiments');
% exp_folder_graph = fullfile(base_folder, 'genus0_connectivity_lap');
% exp_folder_cot = fullfile(base_folder, 'genus0_cot_lap');
% stats_graph = load(fullfile(exp_folder_graph, 'stats.mat'));
% stats_cot = load(fullfile(exp_folder_cot, 'stats.mat'));
% stats_graph = stats_graph.stats;
% stats_cot = stats_cot.stats;
% 
% miq_stats = stats_graph(:, 5);
% IOQ_graph_stats = stats_graph(:, 1:4);
% IOQ_cot_stats = stats_cot(:, 1:4);
% 
% xx = cellfun(@(x) x.nF, miq_stats);
% [xx, inds] = sort(xx);
% 
% miq_stats = miq_stats(inds);
% IOQ_graph_stats = IOQ_graph_stats(inds, :);
% IOQ_cot_stats = IOQ_cot_stats(inds, :);
% 
% % Elapsed time
% % connection laplacian
% figure
% is_valid = @(x) ~isempty(x) && ...
%                 (~isfield(x, 'failed') || ...
%                 ~x.failed);
% valid = cellfun(@(x) is_valid(x), IOQ_graph_stats);
% [rows, cols] = size(IOQ_graph_stats);
% yy_IOQ_graph = inf(rows, cols);
% yy_IOQ_graph(valid) = cellfun(@(x) x.elapsed_total, IOQ_graph_stats(valid));
% [yy_IOQ_graph, I_graph] = min(yy_IOQ_graph, [], 2);
% %yy_IOQ_graph = yy_IOQ_graph(inds);
% %I_graph = I_graph(inds);
% 
% % cot laplacian
% valid = cellfun(@(x) is_valid(x), IOQ_cot_stats);
% [rows, cols] = size(IOQ_cot_stats);
% yy_IOQ_cot = inf(rows, cols);
% yy_IOQ_cot(valid) = cellfun(@(x) x.elapsed_total, IOQ_cot_stats(valid));
% [yy_IOQ_cot, I_cot] = min(yy_IOQ_cot, [], 2);
% %yy_IOQ_cot = yy_IOQ_cot(inds);
% %I_cot = I_cot(inds);
% 
% % miq
% yy_miq = cellfun(@(x) x.elapsed_total, miq_stats);
% %yy_miq = yy_miq(inds);
% 
% plot(xx, yy_IOQ_graph, '--', ...
%     xx, yy_IOQ_cot, '--', ...
%     xx, yy_miq, ['--', experiments{5}.symbol]);
% legends = {'IOQ (connectivity)', 'IOQ (cot)', 'MIQ'};
% 
% symbol_legends = {'cpuinv, cpuloop', ...
%     'cpuinv, gpuloop', ...
%     'blockinv, gpuloop', ...
%     'gpuinv, gpuloop'};
% hold on
% for c = 1:4
%     idx = I_graph == c;
%     if nnz(idx) > 0
%         scatter(xx(idx), yy_IOQ_graph(idx), experiments{c}.symbol);
%         legends{end+1} = symbol_legends{c};
%     end
% end
% hold off
% 
% hold on
% for c = 1:4
%     idx = I_cot == c;
%     if nnz(idx) > 0
%         scatter(xx(idx), yy_IOQ_cot(idx), experiments{c}.symbol);
%     end
% end
% hold off
% 
% legend(legends, 'Location', 'northwest');
% title('Elapsed time')
% 
% % Energy
% % TODO
% figure
% yy_IOQ_graph = inf(rows, cols);
% yy_IOQ_graph(valid) = cellfun(@(x) x.miq_energy, IOQ_graph_stats(valid));
% I = (1 : rows)';
% J = I_graph(:);
% k = sub2ind([rows, cols], I, J);
% yy_IOQ_graph = yy_IOQ_graph(k);
% 
% yy_IOQ_cot = inf(rows, cols);
% yy_IOQ_cot(valid) = cellfun(@(x) x.miq_energy, IOQ_cot_stats(valid));
% I = (1 : rows)';
% J = I_cot(:);
% k = sub2ind([rows, cols], I, J);
% yy_IOQ_cot = yy_IOQ_cot(k);
% 
% yy_miq = cellfun(@(x) x.miq_energy, miq_stats);
% 
% plot(xx, yy_IOQ_graph, '--', ...
%     xx, yy_IOQ_cot, '--', ...
%     xx, yy_miq, ['--', experiments{5}.symbol]);
% legends = {'IOQ (connectivity)', 'IOQ (cot)', 'MIQ'};
% 
% hold on
% for c = 1:4
%     idx = I_graph == c;
%     if nnz(idx) > 0
%         scatter(xx(idx), yy_IOQ_graph(idx), experiments{c}.symbol);
%         legends{end+1} = symbol_legends{c};
%     end
% end
% hold off
% 
% hold on
% for c = 1:4
%     idx = I_cot == c;
%     if nnz(idx) > 0
%         scatter(xx(idx), yy_IOQ_cot(idx), experiments{c}.symbol);
%     end
% end
% hold off
% 
% legend(legends, 'Location', 'northwest');
% title('energy')

% Number of singularities
% TODO
% 
% 
% %%
% plots = {...
%     struct(...
%         'title', 'Elapsed Time', ...
%         'name', 'elapsed_time', ...
%         'get_x_field', @(x) x.nF, ...
%         'get_y_field', @(x) x.miq_energy, ...
%         'style', {{'--'}}, ...
%         'x_col', 5, ...
%         'y_cols', 1:4, ...
%         'symbols', {{'*', 'X', 'O', '^', 'd'}}, ...
%         'symbol_legends', {{'cpuinv, cpuloop', 'cpuinv, gpuloop', 'blockinv, gpuloop', 'gpuinv, gpuloop', 'MIQ'}}, ...
%         'legend', 'IOQ (graph)'), ...
%     struct(...
%         'title', 'Energy', ...
%         'name', 'energy', ...
%         'get_x_field', @(x) x.nF, ...
%         'get_y_field', @(x) x.miq_energy, ...
%         'style', {{'--'}}, ...
%         'x_col', 5, ...
%         'y_cols', 5, ...
%         'symbols', {{'*', 'X', 'O', '^', 'd'}}, ...
%         'symbol_legends', {{'cpuinv, cpuloop', 'cpuinv, gpuloop', 'blockinv, gpuloop', 'gpuinv, gpuloop', 'MIQ'}}, ...
%         'legend', 'MIQ'), ...
%         };
% figure()
% plot_results(plots, stats_graph, {}, []);